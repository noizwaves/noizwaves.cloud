- name: SSH server
  hosts: all
  become: true
  tasks:
    - name: Install SSH server
      ansible.builtin.apt:
        name: openssh-server
    - name: Start SSH server
      ansible.builtin.service:
        name: ssh
        state: started
    - name: Configure SSH server
      ansible.builtin.include_role:
        name: willshersystems.sshd
      vars:
        sshd_install_service: false
        sshd:
          PasswordAuthentication: "no"
          PermitEmptyPasswords: "no"
          PermitRootLogin: "no"
          AllowUsers: cloud
    - name: Install public keys for cloud user
      ansible.builtin.copy:
        dest: /home/cloud/.ssh/authorized_keys
        src: files/authorized_keys
        group: cloud
        owner: cloud
        mode: "600"

- name: Time
  hosts: all
  become: true
  tasks:
    - name: Install NTP
      ansible.builtin.apt:
        name: ntp
    - name: Start NTP
      ansible.builtin.service:
        name: ntp
        state: started
    - name: Set timezone
      community.general.timezone:
        name: "{{ timezone }}"

- name: USB Drives
  hosts: all
  become: true
  tasks:
    - name: Install pmount
      ansible.builtin.apt:
        name: pmount

- name: DNS
  hosts: all
  become: true
  tasks:
    - name: Disable opinionated systemd-resolved
      ansible.builtin.service:
        name: systemd-resolved
        state: stopped
        enabled: false
    - name: Configure upstream DNS servers
      ansible.builtin.copy:
        dest: /etc/resolv.conf
        content: |-
          nameserver 1.1.1.1
          nameserver 1.0.0.1
        group: root
        owner: root
        mode: "644"
